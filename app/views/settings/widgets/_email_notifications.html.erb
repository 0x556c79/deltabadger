<%= turbo_frame_tag "email_notifications" do %>
  <div class="widget widget--settings">
    <% is_gmail_configured = AppConfig.smtp_provider == 'gmail_smtp' %>
    <% is_env_configured = AppConfig.smtp_provider == 'env_smtp' %>
    <% is_configured = AppConfig.smtp_configured? %>
    <h4 class="modal__title">
      <%= t('settings.index.email_notifications_section') %>: 
      <% if is_configured %>
        <span class="text-success">ON</span>
      <% else %>
        <span>OFF</span>
      <% end %>
    </h4>
    <% has_gmail_credentials = AppConfig.smtp_gmail_email.present? && AppConfig.smtp_gmail_password.present? %>

    <%= form_with url: settings_update_email_notifications_path, method: :patch, data: {
      controller: "form--email-notifications",
      turbo_frame: "email_notifications"
    } do |f| %>
      <% show_gmail_form = @show_gmail_form || false %>
      <div class="form__radios" style="display: flex; justify-content: center;">
        <label class="form__radio">
          <%= radio_button_tag :smtp_provider, '', !is_configured && !show_gmail_form, data: { action: "form--email-notifications#selectNone" } %>
          <span><%= t('settings.email_notifications.none') %></span>
        </label>

        <label class="form__radio">
          <%= radio_button_tag :smtp_provider, 'gmail_smtp', is_gmail_configured || show_gmail_form, data: { action: "form--email-notifications#selectGmail" } %>
          <span>Gmail</span>
        </label>

        <% if AppConfig.smtp_env_available? %>
          <label class="form__radio">
            <%= radio_button_tag :smtp_provider, 'env_smtp', is_env_configured, data: { action: "form--email-notifications#selectEnv" } %>
            <span><%= AppConfig.smtp_env_provider_name %></span>
          </label>
        <% end %>
      </div>

      <% if is_gmail_configured %>
        <%# Gmail configured: show status message %>
        <p style="text-align: center; margin-top: 3rem"><%= t('settings.email_notifications.gmail_configured_html', email: AppConfig.smtp_gmail_email) %></p>
        <div class="setting-form">
          <%= link_to t('settings.email_notifications.send_test'), settings_send_test_email_path, data: { turbo_method: :post, turbo_frame: "_top" }, class: "button button--outline" %>
          <%= link_to t('settings.email_notifications.disconnect'), settings_disconnect_email_path, data: { turbo_method: :delete, turbo_frame: "email_notifications" }, class: "button button--danger", style: "margin-top: 0" %>
        </div>
      <% elsif has_gmail_credentials %>
        <%# Credentials exist but Gmail not active - include hidden fields for auto-submit %>
        <%= hidden_field_tag :gmail_email, AppConfig.smtp_gmail_email %>
        <%= hidden_field_tag :gmail_password, AppConfig.smtp_gmail_password %>
      <% else %>
        <%# Gmail setup form (no credentials yet) %>
        <div class="setting-form" data-form--email-notifications-target="gmailFields" style="display: <%= show_gmail_form ? 'flex' : 'none' %>;">
          <div class="form__row form__row--input">
            <%= tag.input class: "form__input",
                          type: "email",
                          name: "gmail_email",
                          id: "gmail_email",
                          placeholder: " " %>
            <%= label_tag :gmail_email, t('settings.email_notifications.gmail_email'), class: "form__label" %>
          </div>
          <div class="form__row form__row--input">
            <%= tag.input class: "form__input",
                          type: "password",
                          name: "gmail_password",
                          id: "gmail_password",
                          placeholder: " " %>
            <%= label_tag :gmail_password, t('settings.email_notifications.gmail_password'), class: "form__label" %>
          </div>
          <p class="form__info"><%= t('settings.email_notifications.gmail_hint_html') %></p>
        </div>
        <div class="setting-form" data-form--email-notifications-target="gmailButtons" style="display: <%= show_gmail_form ? 'flex' : 'none' %>; margin-top: 2rem;">
          <%= f.submit t('settings.email_notifications.set'), class: "button button--success", style: "margin-top: 0" %>
        </div>
      <% end %>

      <%# Env SMTP buttons %>
      <% if is_env_configured %>
        <div class="setting-form" data-form--email-notifications-target="envButtons" style="margin-top: 2rem;">
          <%= link_to t('settings.email_notifications.send_test'), settings_send_test_email_path, data: { turbo_method: :post, turbo_frame: "_top" }, class: "button button--outline" %>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>
